---
title: "R Graph Templates for Visualizing Living Income"
author: "Molly Leavens on behalf of the Sustainable Food Lab"
date: "5/7/2021"
output:  
  pdf_document:
    toc: yes
  html_document:
    toc: yes
urlcolor: blue    
---
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

```{r, echo=FALSE, fig.align='center'}
# Add Sustainable Food Lab logo 
library(knitr)
include_graphics("food-lab-logo-85px.png")

# Add hook so there is a space after each code chunk before each graphic
if(is_latex_output()) {
  plot_default <- knit_hooks$get("plot")
  knit_hooks$set(plot = function(x, options) { 
    x <- c("\\vspace{25pt}", plot_default(x, options))
  })
}
```


\newpage

# Instructions for use

* The Sustainable Food Lab created this document to support companies and research organizations who are visualizing income data and its relationship to established Living Income Benchmarks. This document supplements tools developed by KIT to generate these graphics in [Stata and Excel](https://drive.google.com/drive/folders/10f3vP7j2WFgNKm1t1s4PrwzpSwCHSlzn).     

* The advantages of data cleaning, management, and visualization in R programming language are countless and include: free open source use, reproducibility and documentation of data cleaning, seamless integration with GitHub (a software/platform to track, store, and collaborate on code scripts), and flexible functions. 

* While the code presented in this document is intended to be as user friendly as possible, some basic knowledge of R is necessary. The user will need to understand how to navigate the basic R interface to run the script and export desired graphics. 

* The example graphs below visualize a publicly-available data set based on previous work of KIT for the Living Income Community of Practice.

* The sample data set assigns different Living Income benchmarks to different household types. No changes to the code are necessary if your data only has one benchmark for all household types or genders.  

* **To run your own data through the code provided below, it is imperative that you format your data in exactly the same structure as the sample data set. See the KIT Excel format [HERE](https://drive.google.com/drive/folders/10f3vP7j2WFgNKm1t1s4PrwzpSwCHSlzn) to copy the exact column names for each key variable. If you alter any column names in your data file, you will need to update this code accordingly. Ensure that you format all numerical variables without any commas or currency notations.**

# Troubleshooting
If you are encountering challenges and/or errors when running this code, try these five initial troubleshooting: 
1. Check your 'working directory' and ensure it is the same file destination as where you have saved your data file CSV. A working directory error would occur when trying to upload the data file in the setup.  

2. Ensure all the required libraries are installed on your computer. If you have never used the tidyverse, knitr, or scales libraries, you will need to individually install them first with the function install.packages("LIBRARY NAME").

3. Ensure your data file formatting aligns exactly with the sample excel. The column names must be exactly the same without additional spaces or formatting. Ensure that you format all numerical variables without any commas or currency notations and any blank values are assigned NA.

4. Check for extreme data outliers. Very large, small, or negative income calculations will result in skewed visualizations and could even lead to errors when running the code.

5. Copy the exact error message from R into Google as someone has almost always previously asked about the error message on the forum StackOverflow. 

If you have further questions about this document, please reach out to the Living Income Community of Practice at livingincome@isealalliance.org.

\newpage

# Setup

```{r,echo=FALSE}
knitr::opts_chunk$set(message = FALSE)
```

<p>&nbsp;</p>

```{r, echo=TRUE}
#### Before continuing any further, load the R libraries that have the necessary functions for this analysis. 

# If you have not previously used these libraries, 
# you will need to instaLl them with the function install.packages("LIBRARY NAME"). For example: install.packages(tidyverse)
library(tidyverse)
library(knitr)
library(scales)
```

\newpage

# User entered data

This section allows the user to enter the information specific to their dataset. The user should replace all the wording in ALL CAPS in the following code chunk.   

ALLINGING THE VARIBLE NAMES IS CRITICAL. 

When replacing the capitalized sections, retain the quotation marks. In other words, write your replacement within the quotation marks as this signals to R that you are not referencing an object that already exists.   

For an example of how to fill in the following code chunk, see the following code chunk for the example dataset. 

```{r,eval=FALSE, include=TRUE}
####################### Import data set #######################

# If you have troubles with the import, 
# ensure the original data file is stored in your "working directory"
# (most often the same folder you have saved your working code script)

# If your original data file is saved as an Excel, export it (from Excel,
  # 'save as') as a CSV file before importing it here.
# Ensure the top row of the Excel/CSV is only column names.

df <- read_csv("NAME OF DATA FILE.csv")

## Make all column names syntactically valid
# In R, column names must only consist of letters, numbers, periods, 
  # and underscores. They cannot start with a number nor include spaces.
# If your excel has any column names that do not comply with this syntax,
  # the below code will alter the names accordingly. 

names(df) <- make.names(names(df), unique=TRUE)

####################### Replace variable names #######################
# In the below section, replace the words in all caps with the column   
  # name present in your dataframe.
# NOTE: Ensure that you write the column names exactly as they appear in your
  # data's current dataframe. The make.names() function executed above may have
  # altered some of the column names to enable R compatibility. Run names(df)
  # for a list of your dataset's current column names.   

# Income from main crop
df$income_main_crop <- df$"VARIABLE NAME" 
# Income from all other sources
df$other_income <- df$"VARIABLE NAME"
# Groups to compare incomes between
  # e.g: gender, household size, farm type, etc.  
df$grouping <- df$"VARIABLE NAME"

####################### Replace graph labels #######################
main_crop <- "NAME OF MAIN CROP" # e.g: "cocoa" 
currency <- "CURRENCY OF INCOME DATA" # e.g: "USD"
time_period <- "TIME PERIOD OF INCOME DATA" # e.g: "year"
household <- 

# If you do not already have a variable for total income,
  # you can enter the income_main_crop
total_hh_income <- "TOTAL HH INCOME"
```

## Example dataset 
```{r}
# Import data set
df <- read_csv("KIT_Sample_Data.csv")

# Replace variable names 
df$income_main_crop <- df$total_cocoa_income_2018
#df$other_income <- df$
df$total_hh_income <- df$total_hh_income_2018

# Replace graph labels
main_crop <-"cocoa" 
currency <- "USD"
time_period <- "year"
household <- "Household"
```

# Graph aesthetics changes 

The following code chunk allows the user to define graph colors and fonts. 

OPTIONAL

This is helpful in matching the graphs to reports/presentations.  

## Colors 
```{r}
####################### Colors #######################
If you would like R to assign default colors....

# To see the names of all 657 the built-in colors, use colors()
http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf

## Bar graph sections
# Gap to the mean
gap_color <- 
# Other income
other_color <-   
# Income from main crop
main_color <- 
# Value of crops consumed at home
home_color <- 
  
## Share of observations below the Living Income Benchmark
# Note: these bars all appear the same color
share_color <- 
  
## Distributional plots
  
## By household type
# Group 1
color_1 <- 
# Group 2
color_2 <- 
# Group 3
color_3 <- 

## With mean and median
# Distribution curve 
curve_color <-   
# Income Mean
mean_color <-   
# Income Median
median_color <-  
# Living Income Benchmark 
benchmark_color <-   
```

### Default colors 
```{r}
## Bar graph sections
# Gap to the mean
gap_color <- "#ed3833"
# Other income
other_color <- "#b3dceb"  
# Income from main crop
main_color <- "#b3b3fa"
# Value of crops consumed at home
home_color <- "#fad8b3"
  
## Share of observations below the Living Income Benchmark
# Note: these bars all appear the same color
share_color <- "#ed3833"
  
## Distributional plots
  
## By household type
# Group 1
color_1 <- "#c1dfc1"
# Group 2
color_2 <- "#b6dce8"
# Group 3
color_3 <- "#c2c1fa"

## With mean and median
# Distribution curve 
curve_color <- "#b6dce8" 
# Income Mean
mean_color <- "blue"  
# Income Median
median_color <-  "green"
# Living Income Benchmark 
benchmark_color <- "red"   
```

## Fonts

Set the font in this code chunk that you would like for all of the following graphs and data tables.

If you do not set the font, the R default font, which is Arial. 

```{r}
# If you have previously imported fonts in R, you can skip steps 1 and 2.

# Step 1: Load extrafont library
library(extrafont)

# Step 2: Import fonts already on your system
# For guidance on uploading a custom font, view [this article] (https://r-coder.com/custom-fonts-r/)
font_import()
# After running the font_import() function, you will likely be prompted with   
  # the following message: "Importing fonts may take a few minutes, depending   
  # on the number of fonts and the speed of the system. Continue? [y/n]"
  # Type Y, then enter and the function should run.

# Step 3: Output table with all available fonts.
fonttable()  

# Step 4: Select your desired font
# Ensure you paste the 'FontName' as listed in the front table printed in step 3
  # There should not be any spaces in the same pasted below
font <- "PASTE THE NAME OF DESIRED FONT HERE." # e.g.: "CourierNewPSMT"

# Step 5: Set default to your selected font.
theme_set(theme_get() + theme(text = element_text(family = font)))

```



# The gap of the mean income to the Living Income Benchmark - bar chart

```{r,}
## The first section of this code summarizes and formats the data to be graph-ready
df %>% 
# Group by household type
  group_by(grouping) %>% 
# For each household type, summarize the mean gap to the living income, 
# the mean other income, and the mean main_crop income 
  summarise(Gap = mean(benchmark - total_hh_income),
            Other = mean(total_hh_income - income_main_crop),
            main_crop = mean(income_main_crop)) %>% 
# Gather each income components into one column so the data is in 'long' format
  gather(key = "Component", value = "Income", Gap:main_crop) %>% 
# Re-level the income factors for the order you want them stacked on the graph  
  mutate(Component = factor(Component, 
                            levels = c("Gap", "Other", "main_crop"))) %>% 
# Generate ggplot graph for income by gender and income component  
  ggplot(aes(y = Income, x = grouping, fill = Component)) +
# Assign graph as stacked bar chart  
  geom_bar(position = "stack", stat = "identity") +
# Label the graph title, axis, and caption  
  labs(title = "Mean values", 
       y = paste(currency, "/", time_period, "/", household),
       x = "",
# Add caption with observation numbers for each household type  
       caption = paste("Based on: \n", 
                   paste(names(table(df$grouping)), 
                       ":", 
                       as.numeric(table(df$grouping)), 
                       "observations \n ", collapse = ''), collapse = '')) +
# Label the legend and assign custom colors 
  scale_fill_manual(values=c(gap_color, other_color, main_color),
                    breaks=c("Gap", "Other", "main_crop"),
                    labels=c("Gap to the Living Income Benchmark",
                                "Other income",
                                "Income from main crop")) +
# Format y-axis labels with a comma  
  scale_y_continuous(labels = comma) +
# Remove x-axis grid lines and tick marks  
  theme(panel.grid.major.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
# Center plot title        
        plot.title = element_text(hjust = 0.5),
# Move the legend to the bottom of the graph
        legend.position="bottom",
# Remove legend title
        legend.title = element_blank(),
# Put a box around the legend
        legend.box.background = element_rect(),
# Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
# Add incomes to prospective graph components  
  geom_text(aes(label = round(Income)), 
            position = position_stack(vjust = 0.5), 
            size = 3) 
```

\newpage

# The gap of the relative mean income to the Living Income Benchmark - bar chart

```{r,}
## The first section of this code summarizes and formats the data to be graph-ready
df %>% 
# Group by household type
  group_by(grouping) %>% 
# For each household type, summarize the mean gap to the living income, 
# the mean other income, and the mean main_crop income. 
# Calculate all as percentages of the Living income benchmark - the total of the income and gap
  summarise(Gap = mean((benchmark - total_hh_income)/benchmark),
            Other = mean((total_hh_income - income_main_crop)/benchmark),
            main_crop = mean(income_main_crop/benchmark)) %>% 
# Gather each income components into one column so the data is in 'long' format
  gather(key = "Component", value = "Income", Gap:main_crop) %>% 
# Re-level the income factors for the order you want them stacked on the graph  
  mutate(Component = factor(Component, 
                            levels = c("Gap", "Other", "main_crop"))) %>% 
# Generate ggplot graph for income by gender and income component  
  ggplot(aes(y = Income, x = grouping, fill = Component)) +
# Assign graph as stacked bar chart  
  geom_bar(position = "stack", stat = "identity") +
# Label the graph title, axis, and caption  
  labs(title = "Mean values in relation to the benchmark value", 
       y = "% of the benchmark value",
       x = "",
# Add caption with observation numbers for each household type            
       caption = paste("Based on: \n", 
                   paste(names(table(df$grouping)), 
                       ":", 
                       as.numeric(table(df$grouping)), 
                       "observations \n ", collapse = ''), collapse = '')) +
# Label the legend  
  scale_fill_discrete(breaks=c("Gap",
                                "Other",
                                "main_crop"),
                      labels=c("Gap to the Living Income Benchmark",
                                "Other income",
                                "Income from main crop")) +
# Format y-axis labels with a comma  
  scale_y_continuous(labels = percent) +
# Remove x-axis grid lines and tick marks  
  theme(panel.grid.major.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
# Center plot title        
        plot.title = element_text(hjust = 0.5),
# Move the legend to the bottom of the graph
        legend.position="bottom",
# Remove legend title
        legend.title = element_blank(),
# Put a box around the legend
        legend.box.background = element_rect(),
# Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
# Add incomes to prospective graph components  
  geom_text(aes(label = label_percent(accuracy = 1L)(Income)), 
            position = position_stack(vjust = 0.5), 
            size = 3) 
```

\newpage

# The gap of the absolute median income to the Living Income Benchmark - bar chart

```{r,}
## The first section of this code summarizes and formats the data to be graph-ready
df %>% 
# Group by household type
  group_by(grouping) %>% 
# For each gender, summarize the median gap to the living income, 
# the median other income, and the median main_crop income. 
  summarise(Gap = median(benchmark - total_hh_income),
            Other = median(total_hh_income - income_main_crop),
            main_crop = median(income_main_crop)) %>% 
# Gather each income components into one column so the data is in 'long' format
  gather(key = "Component", value = "Income", Gap:main_crop) %>% 
# Re-level the income factors for the order you want them stacked on the graph  
  mutate(Component = factor(Component, 
                            levels = c("Gap", "Other", "main_crop"))) %>% 
# Generate ggplot graph for income by gender and income component  
  ggplot(aes(y = Income, x = grouping, fill = Component)) +
# Assign graph as stacked bar chart  
  geom_bar(position = "stack", stat = "identity") +
# Label the graph title, axis, and caption  
  labs(title = "Median values", 
       y = paste(currency, "/", time_period, "/", household),
       x = "",
# Add caption with observation numbers for each household type               
       caption = paste("Based on: \n", 
                   paste(names(table(df$grouping)), 
                       ":", 
                       as.numeric(table(df$grouping)), 
                       "observations \n ", collapse = ''), collapse = '')) +
# Label the legend and assign custom colors 
  scale_fill_manual(values=c(gap_color, other_color, main_color),
                    breaks=c("Gap", "Other", "main_crop"),
                    labels=c("Gap to the Living Income Benchmark",
                                "Other income",
                                "Income from main crop")) +
# Format y-axis labels with a comma  
  scale_y_continuous(labels = comma) +
# Remove x-axis grid lines and tick marks  
  theme(panel.grid.major.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
# Center plot title        
        plot.title = element_text(hjust = 0.5),
# Move the legend to the bottom of the graph
        legend.position="bottom",
# Remove legend title
        legend.title = element_blank(),
# Put a box around the legend
        legend.box.background = element_rect(),
# Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
# Add incomes to prospective graph components  
  geom_text(aes(label = round(Income)), 
            position = position_stack(vjust = 0.5), 
            size = 3) 
```

\newpage

# The gap of the relative median income to the Living Income Benchmark - bar chart

```{r,}
## The first section of this code summarizes and formats the data to be graph-ready
df %>% 
# Group by household type
  group_by(grouping) %>% 
# For each gender, summarize the median gap to the living income, 
# the median other income, and the median main_crop income. 
# Calculate all as percentages of the Living income benchmark - the total of the income and gap
  summarise(Gap = median((benchmark - total_hh_income)/benchmark),
            Other = median((total_hh_income - income_main_crop)/benchmark),
            main_crop = median(income_main_crop/benchmark)) %>% 
# Gather each income components into one column so the data is in 'long' format
  gather(key = "Component", value = "Income", Gap:main_crop) %>% 
# Re-level the income factors for the order you want them stacked on the graph  
  mutate(Component = factor(Component, 
                            levels = c("Gap", "Other", "main_crop"))) %>% 
# Generate ggplot graph for income by gender and income component  
  ggplot(aes(y = Income, x = grouping, fill = Component)) +
# Assign graph as stacked bar chart  
  geom_bar(position = "fill", stat = "identity") +
# Label the graph title, axis, and caption  
  labs(title = "Median values in relation to the benchmark value", 
       y = "% of the benchmark value",
       x = "",
# Add caption with observation numbers for each household type         
       caption = paste("Based on: \n", 
                   paste(names(table(df$grouping)), 
                       ":", 
                       as.numeric(table(df$grouping)), 
                       "observations \n ", collapse = ''), collapse = '')) +
# Label the legend and assign custom colors 
  scale_fill_manual(values=c(gap_color, other_color, main_color),
                    breaks=c("Gap", "Other", "main_crop"),
                    labels=c("Gap to the Living Income Benchmark",
                                "Other income",
                                "Income from main crop")) +
# Format y-axis labels with a comma  
  scale_y_continuous(labels = percent) +
# Remove x-axis grid lines and tick marks  
  theme(panel.grid.major.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
# Center plot title        
        plot.title = element_text(hjust = 0.5),
# Move the legend to the bottom of the graph
        legend.position="bottom",
# Remove legend title
        legend.title = element_blank(),
# Put a box around the legend
        legend.box.background = element_rect(),
# Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
# Add incomes to prospective graph components  
  geom_text(aes(label = label_percent(accuracy = 1L)(Income)), 
            position = position_stack(vjust = 0.5), 
            size = 3) 
```

\newpage

# Bar charts including the intrinsic value of food produced and consumed at home

## The gap of the absolute median income to the Living Income Benchmark - bar chart

```{r,}
## The first section of this code summarizes and formats the data to be graph-ready
df %>% 
# Group by gender
  group_by(grouping) %>% 
# For each gender, summarize the median gap to the living income, 
# the median other income, and the median main_crop income. 
  summarise(Gap = median(benchmark - total_hh_income),
            Other = median(total_hh_income - income_main_crop),
            Food = median(food_value),
            main_crop = median(income_main_crop)) %>% 
# Gather each income components into one column so the data is in 'long' format
  gather(key = "Component", value = "Income", Gap:main_crop) %>% 
# Re-level the income factors for the order you want them stacked on the graph  
  mutate(Component = factor(Component, 
                            levels = c("Gap", "Food", "Other", "main_crop"))) %>% 
# Generate ggplot graph for income by gender and income component  
  ggplot(aes(y = Income, x = grouping, fill = Component)) +
# Assign graph as stacked bar chart  
  geom_bar(position = "stack", stat = "identity") +
# Label the graph title, axis, and caption  
  labs(title = "Median values", 
       y = paste("(", currency, "/", time_period, "/", household, ")"),
       x = "",
# Add caption with observation numbers for each household type          
       caption = paste("Based on: \n", 
                   paste(names(table(df$grouping)), 
                       ":", 
                       as.numeric(table(df$grouping)), 
                       "observations \n ", collapse = ''), collapse = '')) +
# Label the legend and assign custom colors 
  scale_fill_manual(values=c(gap_color, home_color, other_color, main_color),
                    breaks=c("Gap", "Food", "Other", "main_crop"),
                    labels=c("Gap to the Living Income Benchmark",
                             "Value of crops consumed at home",
                              "Other income",
                              "Income from main crop")) +
# Wrap legend onto 2 lines to fit everything neatly     
  guides(fill = guide_legend(nrow = 2)) +
# Format y-axis labels with a comma  
  scale_y_continuous(labels = comma) +
# Remove x-axis grid lines and tick marks  
  theme(panel.grid.major.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
# Center plot title        
        plot.title = element_text(hjust = 0.5),
# Move the legend to the bottom of the graph
        legend.position="bottom",
# Remove legend title
        legend.title = element_blank(),
# Put a box around the legend
        legend.box.background = element_rect(),
# Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
# Add incomes to prospective graph components  
  geom_text(aes(label = round(Income)), 
            position = position_stack(vjust = 0.5), 
            size = 3) 
```

\newpage

## The gap of the relative median income to the Living Income Benchmark - bar chart

```{r,}
## The first section of this code summarizes and formats the data to be graph-ready
df %>% 
# Group by household type
  group_by(grouping) %>% 
# For each household type, summarize the median gap to the living income,
# the median other income, and the median main_crop income. 
# Calculate all as percentages of the Living income benchmark - the total of the income and gap
  summarise(Gap = median((benchmark - total_hh_income)/benchmark),
            Food = median(food_value/benchmark),
            Other = median((total_hh_income - income_main_crop)/benchmark),
            main_crop = median(income_main_crop/benchmark)) %>% 
# Gather each income components into one column so the data is in 'long' format
  gather(key = "Component", value = "Income", Gap:main_crop) %>% 
# Re-level the income factors for the order you want them stacked on the graph  
  mutate(Component = factor(Component, 
                            levels = c("Gap", "Food", "Other", "main_crop"))) %>% 
# Generate ggplot graph for income by gender and income component  
  ggplot(aes(y = Income, x = grouping, fill = Component)) +
# Assign graph as stacked bar chart 
  geom_bar(position = "fill", stat = "identity") +
# Label the graph title, axis, and caption  
  labs(title = "Median values in relation to the benchmark value", 
       y = "% of the benchmark value",
       x = "", 
# Add caption with observation numbers for each household type            
       caption = paste("Based on: \n", 
                   paste(names(table(df$grouping)), 
                       ":", 
                       as.numeric(table(df$grouping)), 
                       "observations \n ", collapse = ''), collapse = '')) +
# Label the legend and assign custom colors 
  scale_fill_manual(values=c(gap_color, home_color, other_color, main_color),
                    breaks=c("Gap", "Food", "Other", "main_crop"),
                    labels=c("Gap to the Living Income Benchmark",
                             "Value of crops consumed at home",
                              "Other income",
                              "Income from main crop")) +
# Wrap legend onto 2 lines to fit everything neatly     
  guides(fill = guide_legend(nrow = 2)) +
# Format y-axis labels with a comma and assign limits 0-100% 
  scale_y_continuous(labels = percent, limits = c(0,1)) +
# Remove x-axis grid lines and tick marks  
  theme(panel.grid.major.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
# Center plot title        
        plot.title = element_text(hjust = 0.5),
# Move the legend to the bottom of the graph
        legend.position="bottom",
# Remove legend title
        legend.title = element_blank(),
# Put a box around the legend
        legend.box.background = element_rect(),
# Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
# Add incomes to prospective graph components  
  geom_text(aes(label = label_percent(accuracy = 1L)(Income)), 
            position = position_stack(vjust = 0.5), 
            size = 3) 
```

\newpage

# Share of those below the Living Income benchmark - bar chart

```{r,}
df %>% 
# Group by household type  
  group_by(grouping) %>% 
# For each household type, calculate the percentage above the living income benchmark 
  summarise(Below = sum(below_benchmark)/n()) %>% 
# Generate ggplot graph for percentage by gender 
  ggplot(aes(x = grouping, y = Below)) +
# Assign graph as bar graph and color bars red for aesthetics   
  geom_col(fill= share_color) +
# Label the graph title, axis, and caption    
  labs(title = "Share of observations below the Living Income Benchmark",
       y = "Proportion of households",
       x = "",
# Add caption with observation numbers for each household type    
       caption = paste("Based on: \n", 
                   paste(names(table(df$grouping)), 
                       ":", 
                       as.numeric(table(df$grouping)), 
                       "observations \n ", collapse = ''), collapse = '')) +
# Format y-axis labels with a percent  
  scale_y_continuous(labels = percent) +
# Remove x-axis grid lines and tick marks    
  theme(panel.grid.major.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
# Center plot title          
        plot.title = element_text(hjust = 0.5),
# Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
# Add percents to each graph bar   
  geom_text(aes(label = label_percent(accuracy = 1L)(Below)),
            position = position_stack(vjust = 0.5), 
            size = 3) 
```

\newpage

# Share of those below the Living Income Benchmark - distributional plot 

* The KIT Guidance Document displays this graph style as a smooth histogram with binned income ranges. However, for a variety of reasons, we felt that the data would be better visualized with a density graph, so that is what the below code outputs.

## By household type
```{r,}
df %>%
# Set x-axis to total household income
  ggplot(aes(x = total_hh_income,
# Color by household type            
             fill = grouping)) +
# Add density line. You can change the fill and line colors.
  geom_density(alpha = 0.9, color = "grey") +
  
### Add vertical lines for Living Income benchmark(s)
# Add and/or subtract lines based on number of household types
# and if you have a different benchmark for each.
  geom_vline(aes(xintercept = 4001, 
                 color = "Living Income Female-headed: 90% below"),
             key_glyph = "path") +
  geom_vline(aes(xintercept = 4742, 
                 color = "Living Income Male-headed, typical: 91% below"),
             key_glyph = "path") +
  geom_vline(aes(xintercept = 5123, 
                 color = "Living Income Male-headed, large: 59% below"),
             key_glyph = "path") +
  scale_color_manual(name = "Legend", 
                     values = c(paste("Living Income", names(table(df$grouping))[1], 90% "below" = color_1,
                                "Living Income Male-headed, typical: 91% below"= color_2,
                                "Living Income Male-headed, large: 59% below"= color_3)) + 
# Add graph and axis labels
  labs(x = paste("Estimated Total", household, "Income (", 
                 currency, "/", time_period, "/", household, ")"),
       y = "Proportion of households",
# Add caption with observation numbers for each household type               
       caption = paste("Based on: \n", 
                   paste(names(table(df$grouping)), 
                       ":", 
                       as.numeric(table(df$grouping)), 
                       "observations \n ", collapse = ''), collapse = '')) +
# Format x-axis labels as numbers with commas
# If your data has extreme income outliers, 
    # you may need to filter them or add x-axis limits so they do not warp the graph 
  scale_x_continuous(labels = comma) +
# Remove y-axis labels and ticks
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), 
# Remove background grid (the grid is the default)
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
# Move the legend to the bottom of the graph
        legend.position="bottom",
# Remove legend title
        legend.title = element_blank(),
# Remove gray background for legend symbols 
        legend.key=element_rect(fill=NA),
# Put a box around the legend
        legend.box.background = element_rect(),
# Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
# Wrap legend onto 2 lines to fit everything neatly     
  guides(fill = FALSE) +
# Wrap legend onto 3 lines to fit everything neatly     
  guides(color = guide_legend(nrow = 3)) 

```
\newpage

## With mean and median
```{r,}
df %>%
  # Set x-axis to key variable
  ggplot(aes(x = total_hh_income)) +
  # Add density line. You can change the fill and line colors.
  geom_density(color = "#add8e6", fill = "#add8e6") +
  # Add vertical line for living income
  geom_vline(aes(xintercept = mean(benchmark), 
                 color = "Living Income Benchmark"), key_glyph = "path") +
  # Add vertical line for mean income 
  geom_vline(aes(xintercept = mean(df$total_hh_income), 
                 color = "Income Mean"), key_glyph = "path") +
  # Add vertical line for median income
  geom_vline(aes(xintercept = median(df$total_hh_income), 
                 color = "Income Median"), key_glyph = "path") +
  # Add graph and axis labels
  labs(x = paste("Estimated Total", household, "Income (", 
                 currency, "/", time_period, "/", household, ")", 
                 collapse = ''),
       y = "Proportion of households",
# Add caption with observation numbers for each household type             
       caption = paste("N =", nrow(df), ", bin size = ", 
                       "BINSIZE", collapse = '')) +
  # Format x-axis labels as numbers with commas
  # If your data has extreme income outliers, 
    # you may need to filter them or add x-axis limits so they do not warp the graph 
  scale_x_continuous(labels = comma) +
  # Remove y-axis labels and ticks
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
  # Remove background grid (the grid is the default)
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  # Move the legend to the bottom of the graph
        legend.position="bottom",
  # Remove legend title
        legend.title = element_blank(),
  # Remove gray background for legend symbols 
        legend.key=element_rect(fill=NA),
  # Put a box around the legend
        legend.box.background = element_rect(),
  # Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
  # Manually add legend 
  scale_color_manual(values = c("Living Income Benchmark"= "red",
                                "Income Mean"= "blue",
                                "Income Median"="green"))
```

\newpage

# Foster–Greer–Thorbecke (FGT) index

```{r,}
df %>% 
# Group by household type  
  group_by(grouping) %>% 
# For each gender, calculate the average Foster–Greer–Thorbecke (FGT) index 
  summarise(FGT = mean(fgt_gap)) %>% 
# Generate ggplot graph for percentage by gender 
  ggplot(aes(x = grouping, y = FGT)) +
# Assign graph as bar graph and color bars red for aesthetics   
  geom_col(fill= "red") +
# Label the graph title, axis, and caption    
  labs(title = "FGT index", 
       y = "Index value",
       x = "",
# Add caption with observation numbers for each household type               
       caption = paste("Based on: \n", 
                   paste(names(table(df$grouping)), 
                       ":", 
                       as.numeric(table(df$grouping)), 
                       "observations \n ", collapse = ''), collapse = '')) +
# Format y-axis labels with a percent  
  scale_y_continuous(labels = percent) +
# Remove x-axis grid lines and tick marks    
  theme(panel.grid.major.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
# Center plot title          
        plot.title = element_text(hjust = 0.5),
# Move caption to desired location
        plot.caption = element_text(hjust = 0)) +
# Add percents to each graph bar   
  geom_text(aes(label = label_percent(accuracy = 1L)(FGT)),
            position = position_stack(vjust = 0.5), 
            size = 3) 
```

